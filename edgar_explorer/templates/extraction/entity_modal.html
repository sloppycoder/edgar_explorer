<div class="modal fade" id="genericModal" tabindex="-1" aria-labelledby="genericModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="genericModalLabel"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Dynamic Content -->
                <div id="genericContentContainer"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        var modal = document.getElementById('genericModal');
        modal.addEventListener('show.bs.modal', function (event) {
            // Get the link that triggered the modal
            var link = event.relatedTarget;

            // Extract modal type and data from attributes
            var modalType = link.getAttribute('data-type');
            var modalData = link.getAttribute('data-info');

            try {
                if (modalData.startsWith("```json")) {
                    modalData = modalData.replace("```json", "");
                }
                if (modalData.includes("```")) {
                    modalData = modalData.replace("```", "");
                }
                // Parse the JSON string into an array of response objects
                var responsesData = JSON.parse(modalData);
                console.log('DEBUG: Parsed responsesData:', responsesData);
                console.log('DEBUG: modalType:', modalType);

                // Generic content container
                var contentContainer = modal.querySelector('#genericContentContainer');
                var modalTitle = modal.querySelector('#genericModalLabel');

                // Create dropdown for response selection
                var dropdownHtml = `
                    <div class="mb-3">
                        <label for="responseSelector" class="form-label">Select Response:</label>
                        <select id="responseSelector" class="form-select">
                `;
                
                responsesData.forEach((response, index) => {
                    dropdownHtml += `<option value="${index}">Response ${index + 1}</option>`;
                });
                
                dropdownHtml += `
                        </select>
                    </div>
                    <div id="responseContent"></div>
                `;

                contentContainer.innerHTML = dropdownHtml;

                // Set modal title based on type
                if (modalType === 'trustee') {
                    modalTitle.textContent = 'Trustee Compensations';
                } else if (modalType === 'fundmgr') {
                    modalTitle.textContent = 'Fund Manager Ownership';
                }

                // Function to render response content
                function renderResponseContent(responseIndex) {
                    var responseString = responsesData[responseIndex];
                    console.log('DEBUG: Rendering response index:', responseIndex);
                    console.log('DEBUG: responseString:', responseString);
                    
                    // Parse the individual response string into an object
                    var parsedData = JSON.parse(responseString);
                    console.log('DEBUG: parsedData after parsing:', parsedData);
                    
                    var responseContentDiv = modal.querySelector('#responseContent');

                    if (modalType === 'trustee') {
                        // Build the table HTML for trustees
                        var tableHtml = `
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th style="width: 20%;">Job Title</th>
                                        <th>Name</th>
                                        <th>Fund</th>
                                        <th>Fund Group</th>
                                        <th>Deferred</th>
                                        <th>Other</th>
                                    </tr>
                                </thead>
                                <tbody>
                        `;

                        if (parsedData && parsedData.trustees) {
                            parsedData.trustees.forEach(trustee => {
                                tableHtml += `
                                    <tr>
                                        <td>${trustee.job_title || 'N/A'}</td>
                                        <td>${trustee.name || 'N/A'}</td>
                                        <td>${trustee.fund_compensation || 'N/A'}</td>
                                        <td>${trustee.fund_group_compensation || 'N/A'}</td>
                                        <td>${trustee.deferred_compensation || 'N/A'}</td>
                                        <td>${(trustee.other_compensation && trustee.other_compensation.travel_and_expenses) || 'N/A'}</td>
                                    </tr>
                                `;
                            });
                        }

                        tableHtml += `
                                </tbody>
                            </table>
                            <p class="mt-3">${parsedData.notes || ''}</p>
                        `;

                        responseContentDiv.innerHTML = tableHtml;
                    } else if (modalType === 'fundmgr') {
                        // Build the table HTML for fund managers
                        var tableHtml = `
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Fund</th>
                                        <th>Ownership Range</th>
                                    </tr>
                                </thead>
                                <tbody>
                        `;

                        if (parsedData && parsedData.managers) {
                            parsedData.managers.forEach(manager => {
                                tableHtml += `
                                    <tr>
                                        <td>${manager.name || 'N/A'}</td>
                                        <td>${manager.fund || 'N/A'}</td>
                                        <td>${manager.ownership_range || 'N/A'}</td>
                                    </tr>
                                `;
                            });
                        }

                        tableHtml += `
                                </tbody>
                            </table>
                            <p class="mt-3">${parsedData.notes || ''}</p>
                        `;

                        responseContentDiv.innerHTML = tableHtml;
                    } else {
                        responseContentDiv.innerHTML = '<p class="text-danger">Invalid modal type.</p>';
                    }
                }

                // Initial render of first response
                if (responsesData.length > 0) {
                    renderResponseContent(0);
                }

                // Add event listener for dropdown change
                var responseSelector = modal.querySelector('#responseSelector');
                responseSelector.addEventListener('change', function() {
                    renderResponseContent(parseInt(this.value));
                });
            } catch (error) {
                console.error("Invalid JSON string:", error);

                var contentContainer = modal.querySelector('#genericContentContainer');
                contentContainer.innerHTML = '<p class="text-danger">Unable to load information. Please try again later.</p>';
            }
        });
    });
</script>
