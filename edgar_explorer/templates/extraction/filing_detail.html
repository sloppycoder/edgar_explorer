{% extends "common/base.html" %}

{% block title %}Filing Details - {{ filing.company_name }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-3">
        <div class="col">
            <h2>Filing Details: {{ filing.company_name }}</h2>
            <p class="text-muted">
                {% if filing.model %}<span id="model-display">{{ filing.model }}</span> | {% endif %}
                CIK: {{ filing.cik }} | Form Type: {{ filing.form_type }} | Date Filed: {{ filing.date_filed }} |
                Cost: ${{ filing.cost|floatformat:2 }} |
                <a href="https://www.sec.gov/Archives/edgar/data/{{ filing.cik }}/{{ filing.accession_number|cut:'-' }}/{{ filing.accession_number }}-index.html"
                    target="_blank">{{ filing.accession_number }}</a>
            </p>
        </div>
        <div class="col-auto">
            <a href="{{ back_url }}" class="btn btn-secondary">Back to List</a>
        </div>
    </div>

    <!-- Chunk Selector -->
    <div class="row mb-3">
        <div class="col-md-6">
            <label for="chunkSelector" class="form-label">Select Chunk:</label>
            <select id="chunkSelector" class="form-select">
                {% for chunk in chunks %}
                <option value="{{ forloop.counter0 }}">Chunk {{ chunk }}</option>
                {% empty %}
                <option value="">No chunks available</option>
                {% endfor %}
            </select>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="row">
        <!-- Left Column: Extraction Results -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Extraction Results ({{ filing.info_type|title }})</h5>
                </div>
                <div class="card-body">
                    <div id="extractionContent">
                        <!-- Dynamic content will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column: Source Text -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Source Text <span id="citationCount" class="badge bg-secondary">0
                            citations</span></h5>
                </div>
                <div class="card-body">
                    <textarea id="sourceText" class="form-control" rows="30" readonly>
                        <!-- Dynamic content will be loaded here -->
                    </textarea>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const chunkSelector = document.getElementById('chunkSelector');
        const extractionContent = document.getElementById('extractionContent');
        const sourceText = document.getElementById('sourceText');

        // Format model display to show only part after "/"
        const modelDisplay = document.getElementById('model-display');
        if (modelDisplay && modelDisplay.textContent.includes('/')) {
            const modelParts = modelDisplay.textContent.split('/');
            modelDisplay.textContent = modelParts[modelParts.length - 1];
        }

        // Data from Django template
        const responses = {{ responses| safe }};
    const texts = {{ texts| safe }};
    const citationPositions = {{ citation_positions | safe }};
    const infoType = "{{ filing.info_type }}";

    //console.log('DEBUG: responses:', responses);
    //console.log('DEBUG: texts:', texts);
    //console.log('DEBUG: infoType:', infoType);

    function updateCitationCount(count) {
        const citationCountElement = document.getElementById('citationCount');
        if (citationCountElement) {
            citationCountElement.textContent = `${count} citations`;
        }
    }

    function renderExtractionResults(responseIndex) {
        if (!responses || responseIndex >= responses.length) {
            extractionContent.innerHTML = '<p class="text-muted">No extraction results available for this chunk.</p>';
            updateCitationCount(0);
            return;
        }

        try {
            const responseString = responses[responseIndex];
            const parsedData = JSON.parse(responseString);

            let tableHtml = '';
            let citationCount = 0;

            // Get citation count from citation positions for this chunk
            if (citationPositions && responseIndex < citationPositions.length) {
                citationCount = citationPositions[responseIndex].length;
            }
            updateCitationCount(citationCount);

            if (infoType === 'trustee') {
                tableHtml = `
                    <table class="table table-striped table-sm">
                        <thead>
                            <tr>
                                <th style="width: 20%;">Job Title</th>
                                <th>Name</th>
                                <th>Fund</th>
                                <th>Fund Group</th>
                                <th>Deferred</th>
                                <th>Other</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                if (parsedData && parsedData.trustees) {
                    parsedData.trustees.forEach(trustee => {
                        tableHtml += `
                            <tr>
                                <td>${trustee.job_title || 'N/A'}</td>
                                <td>${trustee.name || 'N/A'}</td>
                                <td>${trustee.fund_compensation || 'N/A'}</td>
                                <td>${trustee.fund_group_compensation || 'N/A'}</td>
                                <td>${trustee.deferred_compensation || 'N/A'}</td>
                                <td>${(trustee.other_compensation && trustee.other_compensation.travel_and_expenses) || 'N/A'}</td>
                            </tr>
                        `;
                    });
                }

                tableHtml += `
                        </tbody>
                    </table>
                    <p class="mt-3">${parsedData.notes || ''}</p>
                `;

                // Add citations and confidence if available
                if (parsedData.citations || parsedData.confidence) {
                    tableHtml += `<div class="mt-3 border-top pt-3">`;
                    if (parsedData.confidence) {
                        tableHtml += `<p><strong>Confidence:</strong> ${parsedData.confidence}</p>`;
                    }
                    if (parsedData.citations) {
                        let citationsHtml = '<p><strong>Citations:</strong></p><ul>';
                        if (Array.isArray(parsedData.citations)) {
                            parsedData.citations.forEach(citation => {
                                if (typeof citation === 'object') {
                                    const location = citation.location || 'N/A';
                                    citationsHtml += `<li>`;
                                    citationsHtml += `<div><strong>Location:</strong> ${location}</div>`;
                                    if (citation.start_text) {
                                        citationsHtml += `<div><strong>Start:</strong> ${citation.start_text}</div>`;
                                    }
                                    if (citation.end_text) {
                                        citationsHtml += `<div><strong>End:</strong> ${citation.end_text}</div>`;
                                    }
                                    citationsHtml += `</li>`;
                                } else {
                                    citationsHtml += `<li>${citation}</li>`;
                                }
                            });
                        } else {
                            citationsHtml += `<li>${parsedData.citations}</li>`;
                        }
                        citationsHtml += '</ul>';
                        tableHtml += citationsHtml;
                    }
                    tableHtml += `</div>`;
                }
            } else if (infoType === 'fundmgr') {
                tableHtml = `
                    <table class="table table-striped table-sm">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Fund</th>
                                <th>Ownership Range</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                if (parsedData && parsedData.managers) {
                    parsedData.managers.forEach(manager => {
                        tableHtml += `
                            <tr>
                                <td>${manager.name || 'N/A'}</td>
                                <td>${manager.fund || 'N/A'}</td>
                                <td>${manager.ownership_range || 'N/A'}</td>
                            </tr>
                        `;
                    });
                }

                tableHtml += `
                        </tbody>
                    </table>
                    <p class="mt-3">${parsedData.notes || ''}</p>
                `;

                // Add citations and confidence if available
                if (parsedData.citations || parsedData.confidence) {
                    tableHtml += `<div class="mt-3 border-top pt-3">`;
                    if (parsedData.confidence) {
                        tableHtml += `<p><strong>Confidence:</strong> ${parsedData.confidence}</p>`;
                    }
                    if (parsedData.citations) {
                        let citationsHtml = '<p><strong>Citations:</strong></p><ul>';
                        if (Array.isArray(parsedData.citations)) {
                            parsedData.citations.forEach(citation => {
                                if (typeof citation === 'object') {
                                    const location = citation.location || 'N/A';
                                    citationsHtml += `<li>`;
                                    citationsHtml += `<div><strong>Location:</strong> ${location}</div>`;
                                    if (citation.start_text) {
                                        citationsHtml += `<div><strong>Start:</strong> ${citation.start_text}</div>`;
                                    }
                                    if (citation.end_text) {
                                        citationsHtml += `<div><strong>End:</strong> ${citation.end_text}</div>`;
                                    }
                                    citationsHtml += `</li>`;
                                } else {
                                    citationsHtml += `<li>${citation}</li>`;
                                }
                            });
                        } else {
                            citationsHtml += `<li>${parsedData.citations}</li>`;
                        }
                        citationsHtml += '</ul>';
                        tableHtml += citationsHtml;
                    }
                    tableHtml += `</div>`;
                }
            } else {
                tableHtml = '<p class="text-danger">Invalid information type.</p>';
            }

            extractionContent.innerHTML = tableHtml;
        } catch (error) {
            console.error('Error parsing response:', error);
            extractionContent.innerHTML = '<p class="text-danger">Error loading extraction results.</p>';
        }
    }

    function updateSourceText(textIndex) {
        if (!texts || textIndex >= texts.length) {
            sourceText.value = 'No source text available for this chunk.';
            return;
        }

        sourceText.value = texts[textIndex] || 'No source text available for this chunk.';
    }

    function updateContent() {
        const selectedIndex = parseInt(chunkSelector.value);
        if (!isNaN(selectedIndex)) {
            renderExtractionResults(selectedIndex);
            updateSourceText(selectedIndex);
        }
    }

    // Event listener for chunk selection
    chunkSelector.addEventListener('change', updateContent);

    // Initial load
    if (chunkSelector.options.length > 0 && chunkSelector.value !== '') {
        updateContent();
    }
});
</script>
{% endblock %}
